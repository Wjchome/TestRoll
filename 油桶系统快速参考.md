# æ²¹æ¡¶ç³»ç»Ÿå¿«é€Ÿå‚è€ƒå¡

## ğŸ¯ ä¸€å›¾çœ‹æ‡‚

```
ç©å®¶              æ²¹æ¡¶              çˆ†ç‚¸
  â”‚                â”‚                 â”‚
  â”œâ”€[Tab]â”€>æ¨¡å¼2   â”‚                 â”‚
  â”‚                â”‚                 â”‚
  â”œâ”€[ç‚¹å‡»]â”€>æ”¾ç½®â”€>åˆ›å»ºæ²¹æ¡¶            â”‚
  â”‚                â”‚                 â”‚
  â”‚                â”œâ”€[HP=50]         â”‚
  â”‚                â”œâ”€[èŒƒå›´=3]         â”‚
  â”‚                â””â”€[ä¼¤å®³=40]        â”‚
  â”‚                                  â”‚
  â”œâ”€[å°„å‡»]â”€â”€â”€â”€â”€â”€â”€â”€>æ²¹æ¡¶HPå‡å°‘        â”‚
  â”‚                â”‚                 â”‚
  â”‚                â””â”€HP=0â”€â”€â”€â”€>è§¦å‘çˆ†ç‚¸
  â”‚                                  â”‚
  â”‚                                  â”œâ”€èŒƒå›´æŸ¥è¯¢(3å•ä½)
  â”‚                                  â”‚
  â”‚                                  â”œâ”€ä¼¤å®³ç©å®¶/åƒµå°¸/å¢™
  â”‚                                  â”‚
  â”‚                                  â””â”€è¿é”å¼•çˆ†æ²¹æ¡¶
```

---

## ğŸ“¦ æ ¸å¿ƒæ–‡ä»¶

### æ–°å¢æ–‡ä»¶ï¼ˆ7ä¸ªï¼‰

```
Components/
â”œâ”€â”€ BarrelComponent.cs        â­ æ²¹æ¡¶ç»„ä»¶
â””â”€â”€ ExplosionComponent.cs     â­ çˆ†ç‚¸ç»„ä»¶

Components/ (ä¿®æ”¹)
â””â”€â”€ PlayerComponent.cs        âœï¸ å¢åŠ barrelCooldownTimerå’ŒsumIndex=3

System/
â”œâ”€â”€ BarrelSystem.cs           â­ æ²¹æ¡¶çˆ†ç‚¸æ£€æµ‹
â”œâ”€â”€ ExplosionSystem.cs        â­ çˆ†ç‚¸ä¼¤å®³å¤„ç†
â”œâ”€â”€ PlayerPlaceBarrelSystem.cs â­ æ”¾ç½®æ²¹æ¡¶
â”œâ”€â”€ PlayerCooldownSystem.cs   âœï¸ å¢åŠ æ²¹æ¡¶å†·å´å¤„ç†
â””â”€â”€ BulletCheckSystem.cs      âœï¸ å­å¼¹å¯ä¼¤å®³æ²¹æ¡¶

ECS/
â””â”€â”€ ECSStateMachine.cs        âœï¸ æ³¨å†Œæ–°System
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### ç©å®¶æ“ä½œ

```
1. æŒ‰Tabåˆ‡æ¢åˆ°æ¨¡å¼2ï¼ˆæ²¹æ¡¶ï¼‰
2. ç‚¹å‡»é¼ æ ‡å·¦é”®æ”¾ç½®æ²¹æ¡¶
3. åˆ‡æ¢åˆ°æ¨¡å¼1ï¼ˆå­å¼¹ï¼‰
4. å°„å‡»æ²¹æ¡¶
5. æ²¹æ¡¶çˆ†ç‚¸ï¼ğŸ’¥
```

### ä»£ç ç¤ºä¾‹

```csharp
// æ”¾ç½®æ²¹æ¡¶
Entity barrel = world.CreateEntity();
world.AddComponent(barrel, BarrelComponent.CreateDefault(playerId));
world.AddComponent(barrel, new Transform2DComponent(position));
world.AddComponent(barrel, new PhysicsBodyComponent(...));
world.AddComponent(barrel, CollisionShapeComponent.CreateCircle((Fix64)0.4f));
world.AddComponent(barrel, new HPComponent(50));

// æ‰‹åŠ¨å¼•çˆ†
if (world.TryGetComponent<BarrelComponent>(barrel, out var comp))
{
    var updated = comp;
    updated.TakeDamage(comp.currentHp); // è‡´å‘½ä¼¤å®³
    world.AddComponent(barrel, updated);
}
```

---

## âš™ï¸ å‚æ•°é…ç½®

| å‚æ•° | é»˜è®¤å€¼ | ä½ç½® |
|------|--------|------|
| æ²¹æ¡¶è¡€é‡ | 50 | `BarrelComponent.CreateDefault()` |
| çˆ†ç‚¸èŒƒå›´ | 3 | `BarrelComponent.explosionRadius` |
| çˆ†ç‚¸ä¼¤å®³ | 40 | `BarrelComponent.explosionDamage` |
| æ”¾ç½®å†·å´ | 2å¸§ | `PlayerComponent.BarrelCooldownDuration` |
| çˆ†ç‚¸æŒç»­ | 10å¸§ | `ExplosionComponent.lifetimeFrames` |

---

## ğŸ”§ Systemæ‰§è¡Œé¡ºåº

```
...
PlayerPlaceWallSystem
PlayerPlaceBarrelSystem   â­ æ”¾ç½®æ²¹æ¡¶
BulletCheckSystem         âœï¸ å­å¼¹ä¼¤å®³æ²¹æ¡¶
BarrelSystem              â­ æ£€æµ‹æ²¹æ¡¶çˆ†ç‚¸
ExplosionSystem           â­ å¤„ç†çˆ†ç‚¸ä¼¤å®³
PhysicsSystem
...
```

**å…³é”®**ï¼šBarrelSystemå¿…é¡»åœ¨ExplosionSystemä¹‹å‰ï¼

---

## ğŸ’¡ æ ¸å¿ƒé€»è¾‘

### 1. æ”¾ç½®æ²¹æ¡¶

```csharp
// PlayerPlaceBarrelSystem
if (currentIndex == 2 
    && IsFire 
    && barrelCooldownTimer <= 0)
{
    PlaceBarrel(world, playerEntity, targetPosition);
}
```

### 2. æ²¹æ¡¶çˆ†ç‚¸

```csharp
// BarrelSystem
if (barrel.currentHp <= 0 || barrel.isDestroyed)
{
    CreateExplosion(world, position, radius, damage);
    world.DestroyEntity(barrelEntity);
}
```

### 3. çˆ†ç‚¸ä¼¤å®³

```csharp
// ExplosionSystem
var entities = physicsSystem.QueryCircleRegion(
    world, position, radius, -1
);

foreach (var entity in entities)
{
    // ä¼¤å®³HPComponent
    if (world.TryGetComponent<HPComponent>(entity, out var hp))
    {
        hp.hp -= explosion.damage;
    }
    
    // è¿é”å¼•çˆ†æ²¹æ¡¶
    if (world.TryGetComponent<BarrelComponent>(entity, out var barrel))
    {
        barrel.TakeDamage(explosion.damage);
    }
}
```

---

## ğŸ® æ¸¸æˆç©æ³•

### è¿é”çˆ†ç‚¸

```
æ”¾ç½®3ä¸ªæ²¹æ¡¶
  â”‚
  â”œâ”€é—´éš”2å•ä½
  â”‚
å°„å‡»ç¬¬1ä¸ª
  â”‚
  â”œâ”€çˆ†ç‚¸ï¼ˆèŒƒå›´3ï¼‰
  â”‚
  â””â”€å¼•çˆ†ç¬¬2ä¸ª
     â”‚
     â”œâ”€çˆ†ç‚¸
     â”‚
     â””â”€å¼•çˆ†ç¬¬3ä¸ª
```

### é™·é˜±è®¾ç½®

```
1. åœ¨è·¯å£æ”¾ç½®æ²¹æ¡¶
2. åƒµå°¸é è¿‘
3. å°„å‡»æ²¹æ¡¶
4. èŒƒå›´çˆ†ç‚¸æ¸…åœº
```

---

## ğŸ› è°ƒè¯•æ¸…å•

```
âœ… æ²¹æ¡¶æ˜¯å¦å‡ºç°åœ¨æ­£ç¡®ä½ç½®
âœ… æ²¹æ¡¶æ˜¯å¦é˜»æŒ¡ç§»åŠ¨
âœ… å­å¼¹æ˜¯å¦èƒ½ä¼¤å®³æ²¹æ¡¶
âœ… æ²¹æ¡¶è¡€é‡æ˜¯å¦æ­£ç¡®å‡å°‘
âœ… è¡€é‡å½’é›¶æ—¶æ˜¯å¦çˆ†ç‚¸
âœ… çˆ†ç‚¸æ˜¯å¦é€ æˆèŒƒå›´ä¼¤å®³
âœ… æ˜¯å¦èƒ½è¿é”å¼•çˆ†æ²¹æ¡¶
âœ… å†·å´æ˜¯å¦æ­£å¸¸å·¥ä½œ
âœ… çˆ†ç‚¸10å¸§åæ˜¯å¦é”€æ¯
```

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### âœ… å¥½çš„åšæ³•

```csharp
// ä½¿ç”¨QuadTreeèŒƒå›´æŸ¥è¯¢
var entities = physicsSystem.QueryCircleRegion(
    world, position, radius, -1
);

// çˆ†ç‚¸è‡ªåŠ¨é”€æ¯
if (explosion.currentFrame >= 10)
{
    world.DestroyEntity(explosionEntity);
}

// é˜²æ­¢é‡å¤å¼•çˆ†
if (!barrel.isDestroyed)
{
    barrel.TakeDamage(damage);
}
```

### âŒ é¿å…çš„åšæ³•

```csharp
// âŒ ä¸è¦éå†æ‰€æœ‰Entity
foreach (var entity in world.GetAllEntities())
{
    // å¤ªæ…¢ï¼
}

// âŒ ä¸è¦å¿˜è®°é”€æ¯çˆ†ç‚¸
// ä¼šå¯¼è‡´å†…å­˜æ³„æ¼

// âŒ ä¸è¦æ— é™é€’å½’çˆ†ç‚¸
// æ£€æŸ¥isDestroyedæ ‡å¿—
```

---

## ğŸ“Š æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥
  â”‚
  â”œâ”€currentIndex=2 + IsFire
  â”‚
  v
PlayerPlaceBarrelSystem
  â”‚
  â”œâ”€åˆ›å»ºBarrelEntity
  â”‚ â”œâ”€BarrelComponent
  â”‚ â”œâ”€PhysicsBodyComponent
  â”‚ â”œâ”€HPComponent
  â”‚ â””â”€Transform2DComponent
  â”‚
  v
å­å¼¹å‡»ä¸­
  â”‚
  v
BulletCheckSystem
  â”‚
  â”œâ”€barrel.TakeDamage(bulletDamage)
  â”‚
  v
BarrelSystem
  â”‚
  â”œâ”€æ£€æµ‹barrel.currentHp <= 0
  â”‚
  â”œâ”€åˆ›å»ºExplosionEntity
  â”‚ â””â”€ExplosionComponent
  â”‚
  â”œâ”€é”€æ¯BarrelEntity
  â”‚
  v
ExplosionSystem
  â”‚
  â”œâ”€QueryCircleRegion(èŒƒå›´3)
  â”‚
  â”œâ”€å¯¹æ‰€æœ‰Entityé€ æˆä¼¤å®³
  â”‚ â”œâ”€ç©å®¶
  â”‚ â”œâ”€åƒµå°¸
  â”‚ â”œâ”€å¢™
  â”‚ â””â”€æ²¹æ¡¶ï¼ˆè¿é”ï¼‰
  â”‚
  â”œâ”€currentFrame++
  â”‚
  â””â”€é”€æ¯ExplosionEntityï¼ˆ10å¸§åï¼‰
```

---

## ğŸ‰ å®Œæˆæ¸…å•

- âœ… BarrelComponentï¼ˆæ²¹æ¡¶ç»„ä»¶ï¼‰
- âœ… ExplosionComponentï¼ˆçˆ†ç‚¸ç»„ä»¶ï¼‰
- âœ… PlayerComponentï¼ˆå¢åŠ æ²¹æ¡¶å†·å´ï¼‰
- âœ… BarrelSystemï¼ˆçˆ†ç‚¸æ£€æµ‹ï¼‰
- âœ… ExplosionSystemï¼ˆä¼¤å®³å¤„ç†ï¼‰
- âœ… PlayerPlaceBarrelSystemï¼ˆæ”¾ç½®ï¼‰
- âœ… BulletCheckSystemï¼ˆå­å¼¹ä¼¤å®³æ²¹æ¡¶ï¼‰
- âœ… PlayerCooldownSystemï¼ˆæ²¹æ¡¶å†·å´ï¼‰
- âœ… ECSStateMachineï¼ˆæ³¨å†ŒSystemï¼‰
- âœ… å®Œæ•´æ–‡æ¡£

---

**æ²¹æ¡¶ç³»ç»Ÿå·²å®Œæˆï¼ç¥ä½ ç©å¾—å¼€å¿ƒï¼** ğŸ’¥ğŸ®

---

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2026-01-20



