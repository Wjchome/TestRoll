# 网络模拟器使用说明

网络模拟器可以模拟网络延迟和丢包，用于测试帧同步游戏在恶劣网络条件下的表现。

## 支持协议

- **TCP**: 传统的面向连接协议
- **UDP**: 无连接的数据报协议（用于帧同步游戏）

## 命令行参数

```bash
# 查看帮助
./network_simulator -h

# UDP测试 - 100ms延迟，5%丢包率
./network_simulator -protocol=udp -listen=9999 -target=127.0.0.1:8888 -delay=100 -loss=5

# TCP测试 - 50ms延迟，无丢包
./network_simulator -protocol=tcp -listen=8089 -target=127.0.0.1:8089 -delay=50 -loss=0

# 高延迟UDP测试
./network_simulator -protocol=udp -listen=8888 -target=127.0.0.1:8888 -delay=200 -loss=10
```

## 参数说明

- `-protocol`: 协议类型 (`tcp` 或 `udp`，默认 `udp`)
- `-listen`: 代理监听端口（客户端连接此端口，默认 `8888`）
- `-target`: 实际服务器地址（代理转发到此，默认 `127.0.0.1:8888`）
- `-delay`: 单向延迟（毫秒，默认 `0`）
- `-loss`: 丢包率（0-100，默认 `0`）

## 使用步骤

### UDP测试

1. **启动实际服务器**:
   ```bash
   cd RollPredictServer
   go run frame_sync_server.go frame_sync_server_kcp.go
   ```
   服务器将在端口 8888 监听UDP连接

2. **启动网络模拟器**:
   ```bash
   ./network_simulator -protocol=udp -listen=9999 -target=127.0.0.1:8888 -delay=100 -loss=5
   ```
   模拟器将在端口 9999 监听，并将数据转发到 8888，添加 100ms 延迟和 5% 丢包

3. **客户端连接**:
   将客户端配置为连接到 `127.0.0.1:9999` 而不是直接连接到服务器

### TCP测试

1. **启动实际服务器**（TCP模式）

2. **启动网络模拟器**:
   ```bash
   ./network_simulator -protocol=tcp -listen=9999 -target=127.0.0.1:8887 -delay=50
   ```

3. **客户端连接到 9999 端口**

## 输出示例

```
========================================
网络模拟器代理启动 (udp)
========================================
代理监听端口: 9999 (客户端连接这里)
转发到服务器: 127.0.0.1:8888 (实际服务器地址)
协议: udp
单向延迟: 100ms (往返延迟: 200ms)
丢包率: 5.00%
========================================
[UDP客户端->服务器] 数据包: 25 字节 from 127.0.0.1:54321, 应用延迟: 100.5ms (目标: 100ms)
[UDP服务器->客户端] 数据包: 18 字节, 应用延迟: 99.8ms (目标: 100ms)
[UDP客户端->服务器] 丢包: 25 字节 from 127.0.0.1:54321
========================================
```

## 注意事项

1. **UDP无连接**: UDP模式下，每个数据包都是独立处理的
2. **延迟应用**: 延迟会应用到每个方向的数据包上
3. **丢包模拟**: 随机丢弃指定百分比的数据包
4. **预测回滚**: 如果客户端使用了预测回滚机制，网络延迟可能会被部分掩盖，但实际延迟仍然存在

## 编译

```bash
cd RollPredictServer
go build -o network_simulator network_simulator.go
```
