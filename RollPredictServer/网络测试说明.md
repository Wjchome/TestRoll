# 网络延迟测试 - 简单说明

## TCP 特性说明

你的项目使用 **TCP 连接**，TCP 保证了：
- ✅ **顺序**：数据包按顺序到达（不会乱序）
- ✅ **可靠性**：不会丢包，TCP 会自动重传丢失的包

**但是**：
- ⚠️ **延迟**：网络延迟是真实存在的，需要测试
- ⚠️ **重传延迟**：虽然 TCP 会重传丢失的包，但重传会导致延迟增加，这在帧同步中仍然是个问题
- ⚠️ **延迟抖动（Jitter）**：延迟的变化也会影响游戏体验

**结论**：
- **乱序**：不需要考虑（TCP 保证顺序）
- **丢包**：虽然 TCP 会重传，但可以测试重传导致的延迟增加
- **延迟**：**这是最重要的，必须测试！**

---

## 推荐工具：network_simulator（代理工具）

### 使用步骤（3步）：

1. **启动服务器**（正常启动）：
   ```bash
   ./frame_sync_server
   ```
   服务器监听：`127.0.0.1:8088`

2. **启动网络模拟器**：
   ```bash
   ./network_simulator -delay 100
   ```
   - `-delay 100`：100毫秒延迟（**最重要**）
   - `-loss 5`：5%丢包率（可选，测试TCP重传延迟）
   - 代理监听：`127.0.0.1:8089`
   - 转发到：`127.0.0.1:8088`（服务器）

3. **修改Unity客户端连接地址**（⚠️ 重要！）：
   - 原地址：`127.0.0.1:8088`（直接连接服务器）
   - **必须改为**：`127.0.0.1:8089`（连接代理）
   
   修改方法：
   - 打开 `FrameSyncNetwork.cs`
   - 修改 `serverPort = 8089;`（原来是 8088）
   - 或者在 Unity Inspector 中修改 `serverPort` 字段
   
   **如果不修改端口，客户端会直接连接服务器，绕过代理，延迟不会生效！**

### 架构图：
```
Unity客户端 → 代理(8089) → 服务器(8088)
            [延迟+可选丢包]
```

### 常用命令：
```bash
# 只测试延迟（推荐）
./network_simulator -delay 100

# 测试延迟 + 丢包（测试TCP重传）
./network_simulator -delay 100 -loss 5

# 自定义端口
./network_simulator -listen 8090 -target 127.0.0.1:8088 -delay 100

# 不同延迟场景测试
./network_simulator -delay 50   # 良好网络
./network_simulator -delay 100  # 一般网络
./network_simulator -delay 200  # 较差网络
./network_simulator -delay 300  # 很差网络
```

---

## 其他工具：simulate_network.sh（不推荐）

这个脚本使用系统级工具，会影响整个系统的网络，需要root权限，配置复杂。

**除非需要系统级测试，否则不要使用。**

---

## 为什么感觉"几乎无延迟"？

你的客户端使用了**预测回滚机制**（PredictionRollbackManager），这会：

1. **客户端预测**：输入后立即在本地执行，让玩家感觉没有延迟
2. **服务器确认**：服务器帧到达后，如果预测正确，就不需要回滚
3. **掩盖延迟**：所以即使有网络延迟，玩家操作仍然感觉流畅

**但是延迟仍然存在！** 只是被预测机制掩盖了。

### 如何验证延迟确实存在？

1. **查看代理日志**：代理会显示数据包传输和延迟应用
2. **测试更大的延迟**：尝试 `-delay 500` 或 `-delay 1000`，应该能感觉到差异
3. **观察回滚**：如果预测失败，客户端会回滚，这时延迟会更明显
4. **禁用预测**：在 Unity 中设置 `PredictionRollbackManager.enablePredictionRollback = false`，就能明显感觉到延迟

### 测试建议：

```bash
# 小延迟（可能感觉不明显，因为预测）
./network_simulator -delay 50

# 中等延迟（应该能感觉到）
./network_simulator -delay 200

# 大延迟（明显感觉）
./network_simulator -delay 500

# 很大延迟（测试极端情况）
./network_simulator -delay 1000
```

---

## 故障排查

如果感觉延迟没有生效，请检查：

1. **客户端是否连接到代理端口？**
   ```bash
   # 运行测试脚本
   ./test_proxy.sh
   ```
   
2. **查看代理日志**：
   - 启动代理后，应该能看到数据包传输日志
   - 如果看不到日志，说明客户端没有连接到代理

3. **确认端口配置**：
   - Unity 客户端：`serverPort = 8089`（代理端口）
   - 服务器：监听 `8088`
   - 代理：监听 `8089`，转发到 `8088`

4. **测试大延迟**：
   ```bash
   # 使用很大的延迟值测试
   ./network_simulator -delay 1000
   # 如果 1000ms 延迟都感觉不到，说明客户端没有连接到代理
   ```

---

## 总结

**就用 `network_simulator` 这一个工具就够了！**

⚠️ **重要提醒**：必须修改 Unity 客户端的 `serverPort` 为 `8089`，否则客户端会直接连接服务器，绕过代理！

延迟是真实存在的，只是被客户端的预测机制掩盖了。这是正常的，也是预测回滚机制的目的 - 让玩家感觉不到延迟！

